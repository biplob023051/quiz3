!function(s){s(document).on("click","button#buy-button",function(e){e.preventDefault(),s("#buy-modal").modal("show")});var e=s("#UserCreateForm"),r="";paymentFormReady=function(){return!!(e.find("input[name=name]").hasClass("success")&&e.find("input[name=email]").hasClass("success")&&e.find("input[name=password]").hasClass("success")&&e.find("input[name=passwordVerify]").hasClass("success")&&s("#cardNumberId").hasClass("success")&&s("#cardExpireId").hasClass("success")&&s("#cardCvcId").val().length>1)};var a=setInterval(function(){paymentFormReady()?s("#create-user").attr("disabled",!1):s("#create-user").attr("disabled",!0)},250);s("#name").focus(function(){s(this).removeClass("success"),s("#name-error").html("").hide()}).blur(function(){var e;""==s(this).val()?(s(this).removeClass("success"),s("#name-error").html(lang_strings.empty_name).show()):(e=s(this).val(),/[a-zA-Z0-9]+/.test(e)?s(this).addClass("success"):(s(this).removeClass("success"),s("#name-error").html(lang_strings.invalid_characters).show()))}),s("#email").focus(function(){s(this).removeClass("success"),s("#email-error").html("").hide()}).blur(function(){var e,r,a;""==s(this).val()?(s(this).removeClass("success"),s("#email-error").html(lang_strings.empty_email).show()):(a=s(this).val(),/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i.test(a)?(e=s(this).val(),s.ajax({dataType:"json",url:projectBaseUrl+"users/ajax_user_checking",type:"post",async:!1,data:{email:e},success:function(s){r=!(!s.success&&"true"!==s.success)}}),r?s(this).addClass("success"):(s(this).removeClass("success"),s("#email-error").html(lang_strings.unique_email).show())):(s(this).removeClass("success"),s("#email-error").html(lang_strings.invalid_email).show()))}),s("#password").focus(function(){s(this).removeClass("success"),s("#password-error").html("").hide()}).blur(function(){""==s(this).val()?(s(this).removeClass("success"),s("#password-error").html(lang_strings.empty_password).show()):s(this).val().length<8?(s(this).removeClass("success"),s("#password-error").html(lang_strings.character_count).show()):s(this).addClass("success")}),s("#passwordverify").focus(function(){s(this).removeClass("success"),s("#passwordverify-error").html("").hide()}).blur(function(){""==s(this).val()||s(this).val()!=s("#password").val()?(s(this).removeClass("success"),s("#passwordverify-error").html(lang_strings.varify_password).show()):s(this).addClass("success")}),s('[data-toggle="tooltip"]').tooltip(),s(document).on("click","#create-user",function(t){if(t.preventDefault(),clearInterval(a),!validator.form())return!1;s("#create-user").html(lang_strings.validating+' <i class="fa fa-spinner fa-pulse"></i>').attr("disabled",!0),Stripe.setPublishableKey(PublishableKey);var i=s("#cardExpireId").payment("cardExpiryVal"),n={number:s("#cardNumberId").val().replace(/\s/g,""),cvc:s("#cardCvcId").val(),exp_month:i.month,exp_year:i.year};Stripe.card.createToken(n,function(a,t){t.error?(e.find(".subscribe").html(lang_strings.retry).prop("disabled",!1),e.find(".payment-errors").text(t.error.message),e.find(".payment-errors").closest(".row").show(),card_success=!1):(s("#create-user").html(lang_strings.processing+' <i class="fa fa-spinner fa-pulse"></i>'),e.find(".payment-errors").closest(".row").hide(),e.find(".payment-errors").text(""),s.post(projectBaseUrl+"users/buyCreate",{token:t.id,name:s("#name").val(),email:s("#email").val(),password:s("#password").val(),passwordVerify:s("#passwordverify").val()}).done(function(e,a,t){1==(e=s.parseJSON(e)).success?(r=e.success_url,window.location=projectBaseUrl+"users/"+r):s("#create-user").html(e.message).removeClass("success").addClass("alert-danger")}).fail(function(r,a,t){s("#create-user").html(lang_strings.pay_failed).removeClass("success").addClass("error"),e.find(".payment-errors").text(lang_strings.try_refresh),e.find(".payment-errors").closest(".row").show()}))})}),s("#invoice-success-dialog").on("hidden.bs.modal",function(){""!=r?window.location=projectBaseUrl+"users/"+r:window.location.reload()}),s("#cardNumberId").payment("formatCardNumber"),s("#cardCvcId").payment("formatCardCVC"),s("#cardExpireId").payment("formatCardExpiry"),jQuery.validator.addMethod("cardNumber",function(s,e){return this.optional(e)||Stripe.card.validateCardNumber(s)},lang_strings.invalid_card),jQuery.validator.addMethod("cardExpiry",function(e,r){return e=s.payment.cardExpiryVal(e),this.optional(r)||Stripe.card.validateExpiry(e.month,e.year)},lang_strings.invalid_expire),jQuery.validator.addMethod("cardCVC",function(s,e){return this.optional(e)||Stripe.card.validateCVC(s)},lang_strings.invalid_cvc),s.extend(s.validator.messages,{required:lang_strings.required_field}),validator=e.validate({rules:{cardNumber:{required:!0,cardNumber:!0},cardExpiry:{required:!0,cardExpiry:!0},cardCVC:{required:!0,cardCVC:!0},email:{required:!1}},highlight:function(e){s(e).closest(".form-control").removeClass("success").addClass("error")},unhighlight:function(e){s(e).closest(".form-control").removeClass("error").addClass("success")},errorPlacement:function(e,r){s(r).closest(".form-group").append(e)}})}(jQuery);