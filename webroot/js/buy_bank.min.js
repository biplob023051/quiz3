!function(s){function e(s){return/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i.test(s)}function r(s){return/[a-zA-Z0-9]+/.test(s)}function a(e){var r;return s.ajax({dataType:"json",url:projectBaseUrl+"users/ajax_user_checking",type:"post",async:!1,data:{email:e},success:function(s){r=!(!s.success&&"true"!==s.success)}}),r}s(document).on("click","button#buy-button",function(e){e.preventDefault(),s("#buy-modal").modal("show")});var t=s("#UserCreateForm"),i="";paymentFormReady=function(){return!!(t.find("[name=name]").hasClass("success")&&t.find("[name=email]").hasClass("success")&&t.find("[name=password]").hasClass("success")&&t.find("[name=passwordVerify]").hasClass("success")&&t.find("[name=cardNumber]").hasClass("success")&&t.find("[name=cardExpiry]").hasClass("success")&&t.find("[name=cardCVC]").val().length>1)};var n=setInterval(function(){paymentFormReady()?s("#create-user").attr("disabled",!1):s("#create-user").attr("disabled",!0)},250);s("#name").focus(function(){s(this).removeClass("success"),s("#name-error").html("").hide()}).blur(function(){""==s(this).val()?(s(this).removeClass("success"),s("#name-error").html(lang_strings.empty_name).show()):r(s(this).val())?s(this).addClass("success"):(s(this).removeClass("success"),s("#name-error").html(lang_strings.invalid_characters).show())}),s("#email").focus(function(){s(this).removeClass("success"),s("#email-error").html("").hide()}).blur(function(){""==s(this).val()?(s(this).removeClass("success"),s("#email-error").html(lang_strings.empty_email).show()):e(s(this).val())?a(s(this).val())?s(this).addClass("success"):(s(this).removeClass("success"),s("#email-error").html(lang_strings.unique_email).show()):(s(this).removeClass("success"),s("#email-error").html(lang_strings.invalid_email).show())}),s("#password").focus(function(){s(this).removeClass("success"),s("#password-error").html("").hide()}).blur(function(){""==s(this).val()?(s(this).removeClass("success"),s("#password-error").html(lang_strings.empty_password).show()):s(this).val().length<8?(s(this).removeClass("success"),s("#password-error").html(lang_strings.character_count).show()):s(this).addClass("success")}),s("#passwordverify").focus(function(){s(this).removeClass("success"),s("#passwordverify-error").html("").hide()}).blur(function(){""==s(this).val()||s(this).val()!=s("#password").val()?(s(this).removeClass("success"),s("#passwordverify-error").html(lang_strings.varify_password).show()):s(this).addClass("success")}),s('[data-toggle="tooltip"]').tooltip(),s(document).on("click","#create-user",function(e){if(e.preventDefault(),clearInterval(n),!validator.form())return!1;s("#create-user").html(lang_strings.validating+' <i class="fa fa-spinner fa-pulse"></i>').attr("disabled",!0),Stripe.setPublishableKey(PublishableKey);var r=t.find("[name=cardExpiry]").payment("cardExpiryVal"),a={number:t.find("[name=cardNumber]").val().replace(/\s/g,""),cvc:t.find("[name=cardCVC]").val(),exp_month:r.month,exp_year:r.year};Stripe.card.createToken(a,function(e,r){r.error?(t.find(".subscribe").html(lang_strings.retry).prop("disabled",!1),t.find(".payment-errors").text(r.error.message),t.find(".payment-errors").closest(".row").show(),card_success=!1):(s("#create-user").html(lang_strings.processing+' <i class="fa fa-spinner fa-pulse"></i>'),t.find(".payment-errors").closest(".row").hide(),t.find(".payment-errors").text(""),s.post(projectBaseUrl+"users/buyCreate",{token:r.id,name:s("#name").val(),email:s("#email").val(),password:s("#password").val(),passwordVerify:s("#passwordverify").val()}).done(function(e,r,a){1==(e=s.parseJSON(e)).success?(i=1,s("#create-user").html(e.message+' <i class="fa fa-check"></i>'),s("#buy-modal").modal("hide"),s("#pay-title").html(lang_strings.stripe_pay_scs_title),s("#pay-body").html(lang_strings.stripe_pay_scs_body),s("#invoice-success-dialog").modal("show")):s("#create-user").html(e.message).removeClass("success").addClass("alert-danger")}).fail(function(e,r,a){s("#create-user").html(lang_strings.pay_failed).removeClass("success").addClass("error"),t.find(".payment-errors").text(lang_strings.try_refresh),t.find(".payment-errors").closest(".row").show()}))})}),s("#invoice-success-dialog").on("hidden.bs.modal",function(){""!=i?window.location=projectBaseUrl:window.location.reload()}),s("input[name=cardNumber]").payment("formatCardNumber"),s("input[name=cardCVC]").payment("formatCardCVC"),s("input[name=cardExpiry").payment("formatCardExpiry"),jQuery.validator.addMethod("cardNumber",function(s,e){return this.optional(e)||Stripe.card.validateCardNumber(s)},lang_strings.invalid_card),jQuery.validator.addMethod("cardExpiry",function(e,r){return e=s.payment.cardExpiryVal(e),this.optional(r)||Stripe.card.validateExpiry(e.month,e.year)},lang_strings.invalid_expire),jQuery.validator.addMethod("cardCVC",function(s,e){return this.optional(e)||Stripe.card.validateCVC(s)},lang_strings.invalid_cvc),s.extend(s.validator.messages,{required:lang_strings.required_field}),validator=t.validate({rules:{cardNumber:{required:!0,cardNumber:!0},cardExpiry:{required:!0,cardExpiry:!0},cardCVC:{required:!0,cardCVC:!0},email:{required:!1}},highlight:function(e){s(e).closest(".form-control").removeClass("success").addClass("error")},unhighlight:function(e){s(e).closest(".form-control").removeClass("error").addClass("success")},errorPlacement:function(e,r){s(r).closest(".form-group").append(e)}})}(jQuery);