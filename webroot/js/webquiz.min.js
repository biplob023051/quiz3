var webQuiz={quizId:null,questionData:[],containerDOM:null,choiceTpl:{},cPreviewTpl:{},qPreviewTpl:{},questionTpl:null,choiceTplCache:{},currentEditQid:null,lastEditQid:null,questionTypes:null,baseUrl:"",init:function(e){if(void 0===e.questionTypes)throw new Exception("Must define question types!");this.questionTypes=e.questionTypes,this.previewCallback=e.previewCallback,this.quizId=e.quizId,this.baseUrl=e.baseUrl,this.questionTpl=Handlebars.compile($("#question-edit-template").html()),this.qPreviewTpl=Handlebars.compile($("#question-preview-template").html()),$.each(this.questionTypes,function(e,t){webQuiz.questionTypes[e].QuestionType.id=parseInt(webQuiz.questionTypes[e].QuestionType.id);var i=t.QuestionType.template_name;webQuiz.choiceTpl[i]=Handlebars.compile($("#choice-"+i+"-edit-template").html()),webQuiz.cPreviewTpl[i]=Handlebars.compile($("#choice-"+i+"-preview-template").html())}),Handlebars.registerHelper("choice",function(e,t){var i,n=[],a=t.data.root,s=a.QuestionType.template_name;if(i=!0===a.preview?webQuiz.cPreviewTpl[s]:webQuiz.choiceTpl[s],void 0===e.length)n.push(i(e));else for(var o=0;o<e.length;o++)e[o].id=o,e[o].question_id=a.question_id,n.push(i(e[o]));return n.join("")}),this.containerDOM=$("#questions tbody")},addNewQuestion:function(e){return this.lastEditQid=this.currentEditQid,this.currentEditQid=-1,1==(e=void 0!==e&&e)?this.addQuestion({id:-1,text:"",explanation:"",Choice:[{}],QuestionType:webQuiz.questionTypes[0].QuestionType,isNew:!0,preview:!1,QDisplay:e}):this.addQuestion({id:-1,text:"",explanation:"",Choice:[{}],QuestionType:webQuiz.questionTypes[0].QuestionType,isNew:!0,preview:!1}),webQuiz.choiceSortable(),!0},addQuestion:function(e){var t=this.questionTpl(e);return this.questionData.push(e),this.containerDOM.append(t),!0},deleteQuestion:function(e,t,i){$.ajax({data:{id:e},url:this.baseUrl+"questions/delete",dataType:"json",type:"post",success:function(n){if(!0===n.success){webQuiz.getQuestion(e);t.remove();var a=1;$("#questions > tbody  > tr:not('.others_type')").each(function(){$(this).find(".question_number").html(a),a++}),myChoices[e]&&delete myChoices[e]}else alert("Error! More detailed error is soon to be implemented\n\n");void 0!==i&&i(n)}})},duplicateQuestion:function(e,t){$.ajax({data:{id:e,name:$("#name").val(),description:$("#description").val()},url:this.baseUrl+"questions/duplicate",dataType:"json",type:"post",success:function(e){!0===e.success?window.location.reload():alert(e.message)}})},getQuestion:function(e){e=parseInt(e);var t=null;return $.each(this.questionData,function(i,n){n.id!==e||(t={index:i,value:n})}),t},getQuestionType:function(e){e=parseInt(e);var t=null;return $.each(this.questionTypes,function(i,n){n.QuestionType.id!==e||(t={index:i,value:n})}),t},setToPreview:function(e,t,i,n,a){e=parseInt(e);var s=webQuiz.getQuestion(e),o=t.find("form").serializeJSON();!0!==s.value.preview&&(o.data.isNew=s.value.isNew,o.data.Question.quiz_id=webQuiz.quizId,!0===o.data.isNew&&delete o.question_id,n=void 0!==n?n:"questions/save/",a=void 0!==a?a:1,$.ajax({data:o.data,url:webQuiz.baseUrl+n+e,dataType:"json",type:"post",success:function(n){if(!0===n.success){var o;0==n.Question.case_sensitive&&delete n.Question.case_sensitive,(o=n.Question).Choice=n.Choice,o.QuestionType=webQuiz.getQuestionType(o.question_type_id).value.QuestionType,o.id=parseInt(n.Question.id),o.isNew=!1,o.preview=!0,2==o.question_type_id&&1==n.Question.case_sensitive&&(o.Choice[0].case_sensitive=!0),webQuiz.questionData[s.index]=o,-1==e&&$("#q-1").hasClass("warn")?o.warn_message=!0:$("#q"+e).hasClass("warn")&&(o.warn_message=!0),o.question_number=a,6==o.question_type_id?(o.relatedClass="header",o.showQuestionText=!0):7==o.question_type_id?o.relatedClass="youtube":8==o.question_type_id?o.relatedClass="image-url":9==o.question_type_id&&(o.relatedClass="text-field"),3!=o.question_type_id&&delete o.max_allowed,void 0!==n.dummy&&null!==n.dummy&&$("#q-1").length>=0&&$("#q-1").remove(),$(webQuiz.qPreviewTpl(o)).insertAfter(t),t.remove(),void 0!==i&&("test"==i?$("#questions button.add-choice").trigger("click"):i(o)),-1!=o.id&&6!=o.question_type_id&&(myChoices[o.id]=o.Choice);var u=1;$("#questions > tbody  > tr:not('.others_type')").each(function(){"q-1"!=$(this).attr("id")&&($(this).find(".question_number").html(u),u++)})}else"undefined"!=n.message||null!=n.message?(alert(n.message),$(".edit-done").attr("disabled",!1)):(alert("Error! More detailed error is soon to be implemented\n\n"),window.location.reload())}}))},setToEdit:function(e,t,i){var n=this.getQuestion(e);if(null===n){var a=$.parseJSON(t.find("script").text().trim());if(null===a)return;a.preview=!1,a.isNew=!1,a.id=parseInt(a.id),webQuiz.questionData.push(a),n={index:this.questionData.length-1,value:a}}else{if(!1===n.value.preview)return;this.questionData[n.index].preview=!1}var s=webQuiz.questionTpl(n.value);$(s).insertAfter(t),t.remove(),void 0!==i&&i(n)},addChoice:function(e,t){var i=this.getQuestion(e);if(null!==i){var n=i.value;if(!1===n.QuestionType.multiple_choices){var a=n.QuestionType.template_name;n.QuestionType.template_name="multiple_one"}var s=this.choiceTpl[n.QuestionType.template_name]({id:t.children().length});t.append(s),!1===n.QuestionType.multiple_choices&&(n.QuestionType.template_name=a)}},removeChoice:function(e,t,i){$.ajax({data:{question_id:e,choice:t},url:webQuiz.baseUrl+"questions/removeChoice",dataType:"json",type:"post",success:function(e){!0===e.success&&i.closest(".choice-"+t).remove()}})},dataValidation:function(e){var t=!1,i=$("#q"+webQuiz.currentEditQid).find("div.choices");return 1==e||3==e?(0==(t=webQuiz.choiceValidation(i,e))&&1==e&&(t=webQuiz.singlePointValidation(i)),0==t&&3==e&&(t=webQuiz.multiPointValidation(i))):4==e?t=webQuiz.manualRatingValidation(i):5==e?t=webQuiz.essayValidation(i):2==e?t=webQuiz.automaticRatingValidation(i):7==e?t=webQuiz.youtubeValidation(i):8==e?t=webQuiz.imageUrlValidation(i):9==e&&(t=webQuiz.textTypeValidation(i)),t},youtubeValidation:function(e){var t=!1;return e.find(':input[type="text"]').each(function(){""==$(this).val()&&(t=!0,webQuiz.showAlert(lang_strings.youtube_url))}),t},imageUrlValidation:function(e){var t=!1;return e.find(':input[type="text"]').each(function(){""==$(this).val()&&(t=!0,webQuiz.showAlert(lang_strings.image_url))}),t},textTypeValidation:function(e){var t=!1;return e.find("textarea").each(function(){""==$(this).val()&&(t=!0,webQuiz.showAlert(lang_strings.text_required))}),t},automaticRatingValidation:function(e){var t=!1;if(e.find(':input[type="text"]').each(function(){""==$(this).val()&&(t=!0,webQuiz.showAlert(lang_strings.correct_answer))}),0==t&&(e.find(':input[type="number"]').each(function(){if($(this).val()>0)return t=!1,!1;t=!0}),1==t)){t=!1,$(".alert-danger").remove();var i=$("#q"+webQuiz.currentEditQid);$(i.selector).addClass("warn")}return t},essayValidation:function(e){return e.find(':input[type="text"]').each(function(){if(""==$(this).val()){$(".alert-danger").remove();var e=$("#q"+webQuiz.currentEditQid);$(e.selector).addClass("warn")}}),!1},manualRatingValidation:function(e){var t=!1;if(e.find(':input[type="number"]').each(function(){if($(this).val()>0)return t=!1,!1;t=!0}),1==t){t=!1,$(".alert-danger").remove();var i=$("#q"+webQuiz.currentEditQid);$(i.selector).addClass("warn")}return t},choiceValidation:function(e,t){var i=2;if(3==t&&$("#QuestionMaxAllowed").val()>2&&(i=$("#QuestionMaxAllowed").val()),!(e.find(':input[type="text"]').length<i)){var n=new Array,a=!1;return e.find(':input[type="text"]').each(function(){""==$(this).val()?(a=!0,webQuiz.showAlert(lang_strings.same_choice)):-1==jQuery.inArray($(this).val(),n)?n.push($(this).val()):(a=!0,webQuiz.showAlert(lang_strings.same_choice))}),a}webQuiz.showAlert(lang_strings.no_choice_1+" "+i+" "+lang_strings.no_choice_2)},singlePointValidation:function(e){var t=!1;if(e.find(':input[type="number"]').each(function(){if($(this).val()>0)return t=!1,!1;t=!0}),1==t){t=!1,$(".alert-danger").remove();var i=$("#q"+webQuiz.currentEditQid);$(i.selector).addClass("warn")}return t},multiPointValidation:function(e){var t=0;if(e.find(':input[type="number"]').each(function(){$(this).val()>0&&(t+=1)}),0==t){$(".alert-danger").length&&$(".alert-danger").remove();var i=$("#q"+webQuiz.currentEditQid);$(i.selector).addClass("warn")}return!1},changeChoiceType:function(e,t,i){var n=webQuiz.getQuestionType(t).value.QuestionType,a=n.template_name;void 0!==webQuiz.choiceTpl[a]&&(n.multiple_choices?i.show():i.hide(),void 0===this.choiceTplCache[a+e]&&(this.choiceTplCache[a+e]=webQuiz.choiceTpl[a]()),this.containerDOM.find("#q"+e+" div.choices").html(this.choiceTplCache[a+e]),$.each(this.questionData,function(t,i){if(i.id===e)return webQuiz.questionData[t].QuestionType=n,void(webQuiz.questionData[t].Choice=[])}))},getExistingQuestionData:function(e,t){var i,n,a=webQuiz.getQuestionType(t).value.QuestionType.template_name,s="",o={};myChoices[e]?1!=editing_q_type&&3!=editing_q_type?(o[0]={},o[1]={}):o=myChoices[e]:(o[0]={},o[1]={}),$.each(o,function(e,t){n={id:e,text:t.text,points:t.points,weight:t.weight},i=Handlebars.compile($("#choice-"+a+"-edit-template").html()),s+=i(n)}),this.containerDOM.find("#q"+e+" div.choices").html(s),this.questionOptions(t),$("#QuestionText").parent().show(),$("#q"+e).find("button.add-choice").show(),this.additionalSettings(t)},getExistingQuestionDataRest:function(e,t){var i,n,a=webQuiz.getQuestionType(t).value.QuestionType.template_name,s="",o={};editing_q_type==t?(o=myChoices[e],$.each(o,function(e,t){n={id:e,text:t.text,points:t.points,weight:t.weight,case_sensitive:t.case_sensitive},i=Handlebars.compile($("#choice-"+a+"-edit-template").html()),s+=i(n)})):(i=Handlebars.compile($("#choice-"+a+"-edit-template").html()),s+=i()),this.containerDOM.find("#q"+e+" div.choices").html(s),this.questionOptions(t),this.additionalSettings(t)},additionalSettings:function(e){6==e?($("#QuestionText").attr("placeholder",lang_strings.header_q_title),$("#QuestionExplanation").closest(".row").hide()):($("#QuestionText").attr("placeholder",lang_strings.other_q_title),$("#QuestionExplanation").closest(".row").show()),7==e?($("#QuestionExplanation").attr("placeholder",lang_strings.youtube_exp_text),$(window).width()>975&&$("#QuestionExplanation").closest(".row").children().css({marginTop:"-47px"})):8==e?($("#QuestionExplanation").attr("placeholder",lang_strings.image_exp_text),$(window).width()>975&&$("#QuestionExplanation").closest(".row").children().css({marginTop:"-47px"})):9==e?($("#QuestionExplanation").attr("placeholder",lang_strings.text_exp_text),$(window).width()>975&&$("#QuestionExplanation").closest(".row").children().css({marginTop:"-47px"})):$("#QuestionExplanation").attr("placeholder",lang_strings.other_exp_text),7==e||8==e||9==e?$("#QuestionText").parent().hide():$("#QuestionText").parent().show()},choiceSortable:function(){$(".choices").sortable({tolerance:"pointer",revert:"invalid",placeholder:"row well placeholder tile",forceHelperSize:!0,update:function(){webQuiz.changeChoiceWeightValue()}})},changeChoiceWeightValue:function(){$("#is_sort").length||$("form#QuestionEditForm").append('<input type="hidden" id="is_sort" name="data[is_sort]" value="1" >');var e=$(".number").length;$(".number").each(function(){var t=$(this).children().attr("id").match(/\d+/);$("#Choice"+t+"Weight").val(e),e--})},reArrangeQuestionNumber:function(){var e=1;$("#questions > tbody  > tr:not('.others_type')").each(function(){"q-1"!=$(this).attr("id")&&($(this).find(".question_number").html(e),e++)});var t=[];$("#questions > tbody  > tr").each(function(){"q-1"!=$(this).attr("id")&&t.push(parseInt($(this).attr("id").match(/\d+/)))}),$.ajax({data:{question_ids:t},url:this.baseUrl+"questions/ajax_sort",dataType:"json",type:"post",success:function(e){!0===e.success||alert("Something went wrong, please try again later\n\n")}})},questionOptions:function(e){3==e?$("#max_allowed").show():$("#max_allowed").hide(),8==e?$("#image-section").show():$("#image-section").hide()},showAlert:function(e){$(".alert-danger").remove(),$("#QuestionEditForm").prepend('<div class="alert alert-danger">'+e+"</div>"),setTimeout(function(){$("#QuestionEditForm").find(".alert").fadeOut("show")},3e3)}};