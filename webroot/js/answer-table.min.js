function checkRow(e){var t=!1;e.find("input.update-score").each(function(){void 0===$(this).attr("value")&&(t=!0)}),t?e.addClass("warning"):e.removeClass("warning")}function getUpdated(){var e=$("#quizId").text();$.ajax({async:!1,type:"POST",url:projectBaseUrl+"quizzes/ajax_latest",data:{quizId:e},async:!0,success:function(t){var a=$.parseJSON($("#prev_data").html()),s=$.parseJSON(t);if(JSON.stringify(a.studentIds)==JSON.stringify(s.studentIds)){var n=!1;$.grep(a.onlineStds,function(e){-1==$.inArray(e,s.onlineStds)&&(n=!0,$("tr#student-"+e).find(".online").remove(),$("tr#student-"+e).find(".question-serial").addClass("small-padding-true"))}),n&&$("#prev_data").html(t)}else{if($("#prev_data").html(t),0==s.studentIds.length)return $.grep(a.onlineStds,function(e){-1==$.inArray(e,s.onlineStds)&&($("tr#student-"+e).find(".online").remove(),$("tr#student-"+e).find(".question-serial").addClass("small-padding-true"))}),!1;clearInterval(interval);var r=getCookie("tabInfo");$.ajax({async:!1,dataType:"JSON",type:"POST",url:projectBaseUrl+"quizzes/ajax_update",data:{quizId:e,currentTab:r,old_data:a.studentIds,new_data:s.studentIds},async:!0,success:function(e){$.each(e,function(e,t){updateIndividulaStudent(t)}),interval=setInterval(getUpdated,5e3)}})}}})}function updateIndividulaStudent(e){if(0==$("tr#student-"+e).length)t=parseInt($("#answer-table table tbody tr").length)+1;else{$("tr#student-"+e).find(":input").attr("disabled",!0),$("tr#student-"+e).find(".delete-answer").hide(),$("tr#student-"+e).find(".ajax-loader").show();var t=parseInt($("tr#student-"+e).find(".question-serial").text())}var a=parseInt($("#quizId").text());$.ajax({async:!1,dataType:"html",type:"POST",url:projectBaseUrl+"quizzes/ajax_student_update",data:{student_id:e,sl:t,quiz_id:a},async:!0,success:function(t){if(0==$("tr#student-"+e).length){var a='<tr id="student-'+e+'">';a+=t,a+="</tr>",$("#answer-table table tbody").append(a)}else $("tr#student-"+e).html(t),$("tr#student-"+e).find(".ajax-loader").hide(),$("tr#student-"+e).find(".delete-answer").show(),$("tr#student-"+e).find(":input").attr("disabled",!1);testFunc(),$(".table").trigger("update"),$("#fixTable").tableHeadFixer({head:!0,left:2})}})}function updateStudentInfo(e){var t=e.attr("data-rel"),a=e.val();clearInterval(interval),$.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/ajax_std_update",type:"post",data:{std_info:t,value_info:a},success:function(a){console.log(t),a.success||"true"===a.success?(e.hide(),""==a.changetext?e.prev().show():e.prev().html(a.changetext+' <i class="glyphicon pencil-small"></i>').show(),$(".table").trigger("update")):alert(a.message),clearInterval(interval),interval=setInterval(getUpdated,5e3)}})}function setCookie(e,t,a){var s=new Date;s.setTime(s.getTime()+24*a*60*60*1e3);var n="expires="+s.toGMTString();document.cookie=e+"="+t+"; "+n}function getCookie(e){for(var t=e+"=",a=document.cookie.split(";"),s=0;s<a.length;s++){for(var n=a[s];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}function checkCookie(){var e=getCookie("username");""!=e?alert("Welcome again "+e):""!=(e=prompt("Please enter your name:",""))&&null!=e&&setCookie("username",e,30)}function testFunc(){$("#answer-table input:not(.update-std)").donetyping(function(){$("#ajax-message").hide();var e=parseFloat($(this).attr("current-score"));if((""==$(this).val()||null==$(this).val())&&isNaN(e))return!1;var t=$(this).val();isNaN(t)&&(t="null");var a=parseFloat($(this).attr("max"));if(t<0)return $("#ajax-message").removeClass("alert-success"),$("#ajax-message").addClass("alert-danger"),$("#ajax-message").html(lang_strings.positive_number),$("#ajax-message").show(),$("html, body").animate({scrollTop:$(".page-header").offset().top},500),!1;if(t==e)return!1;if(t>a)return $("#ajax-message").removeClass("alert-success"),$("#ajax-message").addClass("alert-danger"),$("#ajax-message").html(lang_strings.more_point_1+a+lang_strings.more_point_2),$("#ajax-message").show(),$("html, body").animate({scrollTop:$(".page-header").offset().top},500),!1;$(this).attr("current-score",t);var s=parseInt($(this).attr("name")),n=parseInt($(this).attr("question")),r=$(this);clearInterval(interval),$.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/update_score",type:"post",data:{id:n,student_id:s,score:t,current_score:e,max:a},success:function(e){if(e.success||"true"===e.success){if($("#studentscr2-"+s).text(e.score),$("#studentscr1-"+s).text(e.score),r.hasClass("automatic_rating"))r.hide(),r.prev().html('<span class="score automatic">'+t+'</span> <i class="glyphicon pencil-small"></i>').show();else{var a=r.css("background-color"),n=r.css("color");r.css({"background-color":"green",color:"white"}),setTimeout(function(){r.css({"background-color":a,color:n})},1e3)}r.parents(".read-essay").first().length>0&&("null"==t?r.parents(".read-essay").first().prev().children().hide():r.parents(".read-essay").first().prev().children().show(),r.parents(".read-essay").first().prev().children().text(t)),$(".table").trigger("update")}else alert("Something went wrong, try again later");clearInterval(interval),interval=setInterval(getUpdated,5e3)}})})}var interval;$.tablesorter.addParser({id:"submitted",is:function(e){return!1},format:function(e){if(!e)return 0;var t=e.split(", "),a=t[1].split(":"),s=t[0].split(".");return new Date(s[2],parseInt(s[1],10)-1,s[0],a[0],a[1]).getTime()},type:"numeric"}),$.tablesorter.addParser({id:"points",is:function(e){return!1},format:function(e){return e?e.split("/")[0]:0},type:"numeric"}),$(document).ready(function(){var e=parseInt($(window).height())-(parseInt($(".navbar").height())+parseInt($(".page-header").height())+parseInt($("#answer-table-filter").height())+190+parseInt(maintHeight));$("#answer-table tbody").css({height:e}),$("#fixTable").tableHeadFixer({head:!0,left:2}),interval=setInterval(getUpdated,5e3),testFunc(),$(".table").tablesorter({headers:{2:{sorter:"submitted"},4:{sorter:"points"}}})}),function(e){function t(){window.frames.print_frame.document.body.innerHTML=e("#print_div").html(),window.frames.print_frame.window.focus(),window.frames.print_frame.window.print()}e("#maintenance-alert").css({width:e(window).width()}),e("body").css("overflow","hidden"),e.fn.extend({donetyping:function(t,a){a=a||3e3;var s,n=function(e){s&&(s=null,t.call(e))};return this.each(function(t,r){var i=e(r);i.is(":input")&&i.on("keyup keypress mouseup",function(e){"keyup"==e.type&&8!=e.keyCode||(s&&clearTimeout(s),s=setTimeout(function(){n(r)},a))}).on("blur",function(){n(r)})})}}),e(document).on("click","#answer-table-overview",function(){e("#ajax-message").hide(),setCookie("tabInfo","answer-table-overview",1),e(this).hasClass("active")||(e(this).addClass("active"),e("#answer-table-show").removeClass("active"),e(".question-collapse").hide(),e(".progress-section").addClass("overview-section"))}),e(document).on("click","#answer-table-show",function(){e("#ajax-message").hide(),setCookie("tabInfo","answer-table-show",1),e(this).hasClass("active")||(e(this).addClass("active"),e("#answer-table-overview").removeClass("active"),e(".question-collapse").show(),e(".progress-section").removeClass("overview-section"))}),e(document).on("change","#answer-table-filter select",function(){e("form#answer-table-filter").submit()}),e("#answer-table table").find("tr").each(function(){checkRow(e(this))}),"answer-table-show"==getCookie("tabInfo")?e("#answer-table-show").trigger("click"):e("#answer-table-overview").trigger("click"),e(document).on("click","button.read-essay",function(){e(this).next().next().modal("show")}),e(document).on("click","button.delete-answer",function(){var t=e("#confirm-delete"),a=e(this).attr("id"),s=e(this).closest("tr").find(".online").length;e.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/confirmDeleteStudent",type:"post",data:{student_id:a},success:function(e){if(e.success||"true"===e.success){var a="";1==s&&(a+=lang_strings.online_warning),a+=lang_strings.remove_question+e.student_full_name+" ("+e.student_class+lang_strings.with_points+e.student_score+"?",t.find(".modal-body").html(a),t.find(".modal-footer button#confirmed").attr("value",e.student_id),t.modal("show")}else alert("Something went wrong!!! Please try again later")}})}),e(document).on("click","button#confirmed",function(){var t=e(this).attr("value"),a=e("#confirm-delete");e.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/deleteStudent",type:"post",data:{student_id:t},success:function(s){if(a.modal("hide"),s.success||"true"===s.success){e("#ajax-message").removeClass("alert-danger"),e("#ajax-message").addClass("alert-success"),e("button#"+t).closest("tr").remove();var n=1;e("#answer-table > table > tbody  > tr").each(function(){e(this).find(".question-serial").html(n),n++})}else e("#ajax-message").removeClass("alert-success"),e("#ajax-message").addClass("alert-danger");e("#ajax-message").show(),e("#ajax-message").html(s.message)}})}),e(document).on("click","button#print",function(a){a.preventDefault();var s=parseInt(e("#quizId").text());e("#print_div").html(""),window.frames.print_frame.document.body.innerHTML="",e.ajax({async:!1,dataType:"html",type:"POST",url:projectBaseUrl+"quizzes/ajax_print_answer",data:{quizId:s},async:!0,success:function(a){e("#print_div").html(a),t()}})}),printDivCSS=new String('<link rel="stylesheet" href="'+projectBaseUrl+'css/print_test.css" type="text/css" media="print">'),e(document).on("click",".automatic_rating_box",function(){e(".automatic_rating").each(function(){e(this).hide(),e(this).prev().show()}),e(this).hide(),e(this).next().show();var t=e(this);setTimeout(function(){t.next().hide(),t.show()},7e3)}),e(document).on("click",".std-info",function(){e(".update-std").each(function(){e(this).hide(),e(this).prev().show()}),e(this).hide(),e(this).next().show();var t=e(this);setTimeout(function(){t.next().hide(),t.show()},1e4)}),e("input.update-std").donetyping(function(){updateStudentInfo(e(this))}),e("input.update-std").keypress(function(t){13==t.which&&e(this).blur()}),e("#answer-table input:not(.update-std)").keypress(function(t){13==t.which&&e(this).blur()})}(jQuery);