function checkRow(e){var t=!1;e.find("input.update-score").each(function(){void 0===$(this).attr("value")&&(t=!0)}),t?e.addClass("warning"):e.removeClass("warning")}var interval,globalOffline={},checkOffline=setInterval(checkOfflineUsers,10700);function checkOfflineUsers(){if(!$.isEmptyObject(globalOffline)){clearInterval(checkOffline);var e=globalOffline;globalOffline={},$.ajax({async:!1,dataType:"JSON",type:"POST",url:projectBaseUrl+"students/checkComplete",data:{std_ids:e},success:function(t){if(t.ids.length>0&&$.each(t.ids,function(t,s){var a=s.id;$progress=$("tr#student-"+a).find('.progress[data-value="100"]'),$progress.length>0&&($progress.attr("data-value","101"),$progress.find(".progress-bar").css({backgroundColor:"green"})),delete e[a]}),!$.isEmptyObject(e))for(var s in e)globalOffline[s]=e[s];$(".table").trigger("update"),checkOffline=setInterval(checkOfflineUsers,10700)}})}}function getUpdated(){var e=$("#quizId").text();$.ajax({async:!1,type:"POST",url:projectBaseUrl+"quizzes/ajax_latest",data:{quizId:e},async:!0,success:function(t){var s=$.parseJSON($("#prev_data").html()),a=$.parseJSON(t);if(JSON.stringify(s.studentIds)==JSON.stringify(a.studentIds)){var n=!1;$.grep(s.onlineStds,function(e){-1==$.inArray(e,a.onlineStds)&&(n=!0,$("tr#student-"+e).find(".online").remove(),$("tr#student-"+e).find(".question-serial").addClass("small-padding-true"),globalOffline[e]=e)}),n&&$("#prev_data").html(t)}else{if($("#prev_data").html(t),$.grep(s.onlineStds,function(e){-1==$.inArray(e,a.onlineStds)&&($("tr#student-"+e).find(".online").remove(),$("tr#student-"+e).find(".question-serial").addClass("small-padding-true"),globalOffline[e]=e)}),0==a.studentIds.length)return!1;clearInterval(interval);getCookie("tabInfo");$.ajax({async:!1,dataType:"JSON",type:"POST",url:projectBaseUrl+"quizzes/ajax_update",data:{quizId:e,old_data:s.studentIds,new_data:a.studentIds},async:!0,success:function(e){$.each(e,function(e,t){updateIndividulaStudent(t)}),interval=setInterval(getUpdated,5e3)}})}}})}function updateIndividulaStudent(e){if(0==$("tr#student-"+e).length)var t=parseInt($("#answer-table table tbody tr").length)+1;else{$("tr#student-"+e).find(":input").attr("disabled",!0),$("tr#student-"+e).find(".delete-answer").hide(),$("tr#student-"+e).find(".ajax-loader").show();t=parseInt($("tr#student-"+e).find(".question-serial").text())}var s=parseInt($("#quizId").text());$.ajax({async:!1,dataType:"html",type:"POST",url:projectBaseUrl+"quizzes/ajax_student_update",data:{student_id:e,sl:t,quiz_id:s},async:!0,success:function(t){if(0==$("tr#student-"+e).length){var s='<tr id="student-'+e+'">';s+=t,s+="</tr>",$("#answer-table table tbody").append(s)}else $("tr#student-"+e).html(t),$("tr#student-"+e).find(".ajax-loader").hide(),$("tr#student-"+e).find(".delete-answer").show(),$("tr#student-"+e).find(":input").attr("disabled",!1);testFunc(),$(".table").trigger("update"),$("#fixTable").tableHeadFixer({head:!0,left:2})}})}var headers={2:{sorter:"submitted"},4:{sorter:"points"},5:{sorter:"progressbar"}};function updateStudentInfo(e){var t=e.attr("data-rel"),s=e.val();clearInterval(interval),$.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/ajax_std_update",type:"post",data:{std_info:t,value_info:s},success:function(s){console.log(t),s.success||"true"===s.success?(e.hide(),""==s.changetext?e.prev().show():e.prev().html(s.changetext+' <i class="glyphicon pencil-small"></i>').show(),$(".table").trigger("update")):alert(s.message),clearInterval(interval),interval=setInterval(getUpdated,5e3)}})}function setCookie(e,t,s){var a=new Date;a.setTime(a.getTime()+24*s*60*60*1e3);var n="expires="+a.toGMTString();document.cookie=e+"="+t+"; "+n}function getCookie(e){for(var t=e+"=",s=document.cookie.split(";"),a=0;a<s.length;a++){for(var n=s[a];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(t))return n.substring(t.length,n.length)}return""}function checkCookie(){var e=getCookie("username");""!=e?alert("Welcome again "+e):""!=(e=prompt("Please enter your name:",""))&&null!=e&&setCookie("username",e,30)}function testFunc(){$("#answer-table input:not(.update-std)").donetyping(function(){$("#ajax-message").hide();var e=parseFloat($(this).attr("current-score"));if((""==$(this).val()||null==$(this).val())&&isNaN(e))return!1;var t=$(this).val();isNaN(t)&&(t="null");var s=parseFloat($(this).attr("max"));if(t<0)return $("#ajax-message").removeClass("alert-success"),$("#ajax-message").addClass("alert-danger"),$("#ajax-message").html(lang_strings.positive_number),$("#ajax-message").show(),$("html, body").animate({scrollTop:$(".page-header").offset().top},500),!1;if(t==e)return!1;if(t>s)return $("#ajax-message").removeClass("alert-success"),$("#ajax-message").addClass("alert-danger"),$("#ajax-message").html(lang_strings.more_point_1+s+lang_strings.more_point_2),$("#ajax-message").show(),$("html, body").animate({scrollTop:$(".page-header").offset().top},500),!1;$(this).attr("current-score",t);var a=parseInt($(this).attr("name")),n=parseInt($(this).attr("question")),r=$(this);clearInterval(interval),$.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/update_score",type:"post",data:{id:n,student_id:a,score:t,current_score:e,max:s},success:function(e){if(e.success||"true"===e.success){if($("#studentscr2-"+a).text(e.score),$("#studentscr1-"+a).text(e.score),r.hasClass("automatic_rating"))r.hide(),r.prev().html('<span class="score automatic">'+t+'</span> <i class="glyphicon pencil-small"></i>').show();else{var s=r.css("background-color"),n=r.css("color");r.css({"background-color":"green",color:"white"}),setTimeout(function(){r.css({"background-color":s,color:n})},1e3)}r.parents(".read-essay").first().length>0&&("null"==t?r.parents(".read-essay").first().prev().children().hide():r.parents(".read-essay").first().prev().children().show(),r.parents(".read-essay").first().prev().children().text(t),r.parents(".read-essay").modal("hide")),$(".table").trigger("update")}else alert("Something went wrong, try again later");clearInterval(interval),interval=setInterval(getUpdated,5e3)}})})}void 0!==headerCol.STAR&&$.each(headerCol.STAR,function(e,t){headers[t]={sorter:"star_"+t},$.tablesorter.addParser({id:"star_"+t,is:function(e){return!1},format:function(e,t,s){return $(s).find(".score").text()},type:"numeric"})}),void 0!==headerCol.MCMC&&$.each(headerCol.MCMC,function(e,t){headers[t]={sorter:"mcmc_"+t},$.tablesorter.addParser({id:"mcmc_"+t,is:function(e){return!1},format:function(e,t,s){var a=0;return $(s).find(".score").each(function(){a+=parseInt($(this).text())}),a},type:"numeric"})}),void 0!==headerCol.STMR&&$.each(headerCol.STMR,function(e,t){headers[t]={sorter:"stmr_"+t},$.tablesorter.addParser({id:"stmr_"+t,is:function(e){return!1},format:function(e,t,s){var a=$(s).find("input").val();return a||0},type:"numeric"})}),void 0!==headerCol.ESSAY&&$.each(headerCol.ESSAY,function(e,t){headers[t]={sorter:"essay_"+t},$.tablesorter.addParser({id:"essay_"+t,is:function(e){return!1},format:function(e,t,s){return $(s).find(".score").text()},type:"numeric"})}),$.tablesorter.addParser({id:"submitted",is:function(e){return!1},format:function(e){if(!e)return 0;var t=e.split(", "),s=t[1].split(":"),a=t[0].split(".");return new Date(a[2],parseInt(a[1],10)-1,a[0],s[0],s[1]).getTime()},type:"numeric"}),$.tablesorter.addParser({id:"points",is:function(e){return!1},format:function(e){return e?e.split("/")[0]:0},type:"numeric"}),$.tablesorter.addParser({id:"progressbar",is:function(e){return!1},format:function(e,t,s){return $(s).attr("data-value")},type:"numeric"}),$(document).ready(function(){var e=parseInt($(window).height())-(parseInt($(".navbar").height())+parseInt($(".page-header").height())+parseInt($("#answer-table-filter").height())+190+parseInt(maintHeight));$("#answer-table tbody").css({height:e}),$("#fixTable").tableHeadFixer({head:!0,left:2}),interval=setInterval(getUpdated,5e3),testFunc(),$(".table").tablesorter({headers:headers})}),function(e){e("#maintenance-alert").css({width:e(window).width()}),e("body").css("overflow","hidden"),e.fn.extend({donetyping:function(t,s){s=s||3e3;var a,n=function(e){a&&(a=null,t.call(e))};return this.each(function(t,r){var i=e(r);i.is(":input")&&i.on("keyup keypress mouseup",function(e){"keyup"==e.type&&8!=e.keyCode||(a&&clearTimeout(a),a=setTimeout(function(){n(r)},s))}).on("blur",function(){n(r)})})}}),e(document).on("click","#answer-table-overview",function(){e("#ajax-message").hide(),setCookie("tabInfo","answer-table-overview",1),e(this).hasClass("active")||(e(this).addClass("active"),e("#answer-table-show").removeClass("active"),e(".question-collapse").hide(),e(".progress-section").addClass("overview-section"))}),e(document).on("click","#answer-table-show",function(){e("#ajax-message").hide(),setCookie("tabInfo","answer-table-show",1),e(this).hasClass("active")||(e(this).addClass("active"),e("#answer-table-overview").removeClass("active"),e(".question-collapse").show(),e(".progress-section").removeClass("overview-section"))}),e(document).on("change","#answer-table-filter select",function(){e("form#answer-table-filter").submit()}),e("#answer-table table").find("tr").each(function(){checkRow(e(this))}),"answer-table-show"==getCookie("tabInfo")?e("#answer-table-show").trigger("click"):e("#answer-table-overview").trigger("click"),e(document).on("click","button.read-essay",function(){e(this).next().next().modal("show")}),e(document).on("click","button.delete-answer",function(){var t=e("#confirm-delete"),s=e(this).attr("id"),a=e(this).closest("tr").find(".online").length;e.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/confirmDeleteStudent",type:"post",data:{student_id:s},success:function(e){if(e.success||"true"===e.success){var s="";1==a&&(s+=lang_strings.online_warning),s+=lang_strings.remove_question+e.student_full_name+" ("+e.student_class+lang_strings.with_points+e.student_score+"?",t.find(".modal-body").html(s),t.find(".modal-footer button#confirmed").attr("value",e.student_id),t.modal("show")}else alert("Something went wrong!!! Please try again later")}})}),e(document).on("click","button#confirmed",function(){var t=e(this).attr("value"),s=e("#confirm-delete");e.ajax({async:!1,dataType:"json",url:projectBaseUrl+"students/deleteStudent",type:"post",data:{student_id:t},success:function(a){if(s.modal("hide"),a.success||"true"===a.success){e("#ajax-message").removeClass("alert-danger"),e("#ajax-message").addClass("alert-success"),e("button#"+t).closest("tr").remove();var n=1;e("#answer-table > table > tbody  > tr").each(function(){e(this).find(".question-serial").html(n),n++}),e(".table").trigger("update")}else e("#ajax-message").removeClass("alert-success"),e("#ajax-message").addClass("alert-danger");e("#ajax-message").show(),e("#ajax-message").html(a.message)}})}),e(document).on("click","button#print",function(t){t.preventDefault();var s=parseInt(e("#quizId").text());e("#print_div").html(""),window.frames.print_frame.document.body.innerHTML="",e.ajax({async:!1,dataType:"html",type:"POST",url:projectBaseUrl+"quizzes/ajax_print_answer",data:{quizId:s},async:!0,success:function(t){e("#print_div").html(t),window.frames.print_frame.document.body.innerHTML=e("#print_div").html(),window.frames.print_frame.window.focus(),window.frames.print_frame.window.print()}})}),printDivCSS=new String('<link rel="stylesheet" href="'+projectBaseUrl+'css/print_test.css" type="text/css" media="print">'),e(document).on("click",".automatic_rating_box",function(){e(".automatic_rating").each(function(){e(this).hide(),e(this).prev().show()}),e(this).hide(),e(this).next().show();var t=e(this);setTimeout(function(){t.next().hide(),t.show()},7e3)}),e(document).on("click",".std-info",function(){e(".update-std").each(function(){e(this).hide(),e(this).prev().show()}),e(this).hide(),e(this).next().show();var t=e(this);setTimeout(function(){t.next().hide(),t.show()},1e4)}),e("input.update-std").donetyping(function(){updateStudentInfo(e(this))}),e("input.update-std").keypress(function(t){13==t.which&&e(this).blur()}),e("#answer-table input:not(.update-std)").keypress(function(t){13==t.which&&e(this).blur()})}(jQuery);var showChar=40,ellipsestext="",moretext="...",lesstext="...";$(".more").each(function(){var e=$(this).html();if(e.length>showChar){var t=e.substr(0,showChar),s=e.substr(showChar-1,e.length-showChar),a=t+'<span class="moreellipses">'+ellipsestext+'</span><span class="morecontent"><span style="display: none;">'+s+'</span>&nbsp;<a href="" class="morelink">'+moretext+"</a></span>";$(this).html(a)}}),$(document).on("click",".morelink",function(e){return e.preventDefault(),$(this).hasClass("less")?($(this).removeClass("less"),$(this).html(moretext)):($(this).addClass("less"),$(this).html(lesstext)),$(this).parent().prev().toggle(),$(this).prev().toggle(),!1}),$(window).resize(function(){var e=parseInt($(window).height())-(parseInt($(".navbar").height())+parseInt($(".page-header").height())+parseInt($("#answer-table-filter").height())+190+parseInt(maintHeight));$("#answer-table tbody").css({height:e}),$("#maintenance-alert").css({width:$(window).width()})});